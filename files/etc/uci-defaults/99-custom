# Beware! This script will be in /rom/etc/uci-defaults/ as part of the image.
# Uncomment lines to apply:
#
# wlan_name=
# wlan_password=
# root_password=
#
# pppoe_username=
# pppoe_password=
# vlan_id="500"
#
#lan_ip_address="192.168.0.1"
#
#ipv4_dns1="1.1.1.3"
#ipv4_dns2="1.0.0.3"
#ipv6_dns1="2606:4700:4700::1113"
#ipv6_dns2="2606:4700:4700::1003"

# log potential errors
exec >/tmp/setup.log 2>&1

if [ -n "$root_password" ]; then
  (echo "$root_password"; sleep 1; echo "$root_password") | passwd > /dev/null
fi

# Configure LAN
# More options: https://openwrt.org/docs/guide-user/base-system/basic-networking
if [ -n "$lan_ip_address" ]; then
  uci set network.lan.ipaddr="$lan_ip_address"
  uci commit network
fi

# Configure WLAN
# More options: https://openwrt.org/docs/guide-user/network/wifi/basic#wi-fi_interfaces
if [ -n "$wlan_name" -a -n "$wlan_password" -a ${#wlan_password} -ge 8 ]; then
  # 2.4 GHz
  uci set wireless.@wifi-device[0].disabled='0'
  uci set wireless.@wifi-device[0].country='MY'
  uci set wireless.@wifi-iface[0].disabled='0'
  uci set wireless.@wifi-iface[0].encryption='psk2+ccmp'
  uci set wireless.@wifi-iface[0].ssid="${wlan_name}-2.4G@unifi"
  uci set wireless.@wifi-iface[0].key="$wlan_password"
  # 5 GHz
  uci set wireless.@wifi-device[1].disabled='0'
  uci set wireless.@wifi-device[1].country='MY'
  uci set wireless.@wifi-iface[1].disabled='0'
  uci set wireless.@wifi-iface[1].encryption='psk2+ccmp'
  uci set wireless.@wifi-iface[1].ssid="${wlan_name}-5G@unifi"
  uci set wireless.@wifi-iface[1].key="$wlan_password"
  uci set wireless.@wifi-iface[1].wds='1'
  uci commit wireless
fi

# Configure PPPoE
# More options: https://openwrt.org/docs/guide-user/network/wan/wan_interface_protocols#protocol_pppoe_ppp_over_ethernet
if [ -n "$pppoe_username" -a "$pppoe_password" ]; then
  uci set network.wan.proto=pppoe
  uci set network.wan.username="$pppoe_username"
  uci set network.wan.password="$pppoe_password"
  uci set network.wan.device="wan.${vlan_id}"
  uci commit network
fi

# Configure IPv6
#uci set network.wan.ipv6='1'
#uci set network.wan6.device='@wan'
# uci set network.wan6.reqaddress='try'
# uci set network.wan6.reqprefix='auto'
#uci set dhcp.lan.ra_default='2'
#uci set network.lan.ip6assign='64'
#uci commit dhcp
#uci commit network

# Configure Timezone
timezone='<+08>-8'
zonename='Asia/Kuala Lumpur'
uci set system.@system[0].timezone="$timezone"
uci set system.@system[0].zonename="$zonename"
uci delete system.ntp.server
uci add_list system.ntp.server='my.pool.ntp.org'
uci add_list system.ntp.server='sg.pool.ntp.org'
uci commit system

# Configure custom DNS server
if [ -n "$ipv4_dns1" -a -n "$ipv4_dns2" -a -n "$ipv6_dns1" -a -n "$ipv6_dns2" ]; then
  # IPv4
  uci set network.wan.peerdns="0"
  uci -q delete network.wan.dns
  uci add_list network.wan.dns="$ipv4_dns1"
  uci add_list network.wan.dns="$ipv4_dns2"
  # IPv6
  uci set network.wan6.peerdns="0"
  uci -q delete network.wan6.dns
  uci add_list network.wan6.dns="$ipv6_dns1"
  uci add_list network.wan6.dns="$ipv6_dns2"
  uci commit network
fi


echo "All done!"